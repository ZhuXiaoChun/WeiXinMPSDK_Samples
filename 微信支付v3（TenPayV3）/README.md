# 当前项目为官方项目“Senparc.Weixin.MP Sample”的信息整理
**官方仓库地址：** https://github.com/JeffreySu/WeiXinMPSDK/tree/master/Samples/TenPayV3

**官方文档地址：** https://sdk.weixin.senparc.com/Docs/TenPayV3/


# 1/5，微信支付的整体逻辑结构
微信支付是微信平台的支付工具，支付功能围绕微信平台的应用程序展开，微信平台的应用程序包括：
- 公众号/订阅号，【注意】订阅号**不支持**微信支付功能。
- 公众号/服务号，服务号支持支持微信支付功能。
- 小程序，小程序支持微信支付功能。
所有微信平台应用程序，都具有各自的应用程序Id（AppId）和密钥（Secret)。


# 2/5，微信支付后台，关键配置

## 小程序，为小程序管理支付商户号
- 小程序后台，功能，微信支付，关联更多商户号，按步骤关联已申请并验证通过的支付商户号。

## 微信支付后台，账户中心，Api安全相关设置
- 申请API证书，按流程生成API证书后，注意妥善保存证书文件。
- 设置APIv3密钥，按流程生成APIv3密钥后，注意妥善保存密钥。
- 平台证书，按流程生成平台证书。
- APIv2已过时，无需配置。

## 微信支付后台，产品中心，开发配置
- 支付配置，添加：JSAPI支付，支付授权目录。
- 支付配置，添加：Native支付，Native支付回调链接。


# 3/5，微信支付项目，关键配置

## 微信支付，配置

- 在项目中搜索“**#{服务号或小程序的_开发者Id(AppId)}#**”，替换为小程序后台，开发管理目录下，开发者ID，开发设置部分的，AppID(小程序ID)。
- 在项目中搜索“**#{服务号或小程序的_密钥}#**”，替换为小程序后台，开发管理目录下，开发者ID，开发设置部分的，AppSecret（小程序密钥）。

- 在项目中搜索“**#{微信支付后台_账户中心_商户信息_微信支付商户号}#**”，替换为微信支付后台，账户中心目录下，商户信息，基本账户信息部分的，微信支付商户号。
- 在项目中搜索“**#{微信支付后台_账户中心_API安全_设置APIv3密钥_设置的密钥}#**”，替换为微信支付后台，API安全目录下，设置APIv3密钥部分，之前设置的APIv3密钥。
- 将在“微信支付后台，账户中心，Api安全，申请API证书”中生成的证书文件解压缩，将其中的“apiclient_key.pem”文件，放在当前项目的“App_Data/cert/”目录下。
- 在项目中搜索“**#{微信支付后台_账户中心_API安全_申请API证书_申请后_文件包中的_apiclient_key.pem_文件路径}#**”，替换为“~/App_Data/cert/apiclient_key.pem”，注意，此处路径可自定义，“~”表示当前项目根路径，也可指定为其他的相对路径，或其他的绝对路径。
- 在项目中搜索“**#{微信支付后台_账户中心_API安全_管理证书_证书序列号}#**”，替换为微信支付后台，API安全目录下，**申请API证书**部分，管理证书中的“证书序列号”，**【注意】**如果有多个证书，应当选择创建APIv3密钥时，当前最新的证书序列号。


## 当前服务，配置
- 在项目中搜索“**#{Http服务端口号}#**”，替换为当前服务使用的Http服务端口号。
- 在项目中搜索“**#{Https服务端口号}#**”，替换为当前服务使用的Https服务端口号，如不需要，可删除相关代码块。


# 4/5，验证和部署。
- 直接运行项目，访问“当前项目路径/tenPayApiV3/productList”页面，并点击任意的样例商品。
- 如果“支付方式二：“扫一扫”Native 支付（PC 或外部设备扫码支付）”和“支付方式三：“扫一扫”进入详情支付”，可正常显示二维码，则配置成功。
- 后续正常部署项目即可。


# 5/5，核心功能类
- 可参考项目内的“Controllers/TenPayApiV3Controller.cs”文件。